#!/usr/bin/env bash

. colors

if [[ $1 == "start" ]]; then
	echo -e ""
	echo -e "${CYAN}> Starting services${NOCOLOR}"
	rm /run/hive/NV_OFF > /dev/null 2>&1
	systemctl start hivex > /dev/null 2>&1
	sleep 10
	exit
fi

try_count=3
[[ ! -z $1 ]] && try_count=$1
echo -e ""
echo -e "${CYAN}> Stopping services${NOCOLOR}"
echo 1 > /run/hive/NV_OFF

for (( i=0; i < $try_count; i++ ))
do
	autoswitch stop > /dev/null 2>&1
	miner stop > /dev/null 2>&1
	#wd stop > /dev/null 2>&1
	autofan stop > /dev/null 2>&1
	systemctl stop hivex > /dev/null 2>&1
	sleep 1
	killall -9 xinit > /dev/null 2>&1 && sleep 0.5
	killall nvidia-persistenced > /dev/null 2>&1 && sleep 0.5
	rmmod -f nvidia_uvm > /dev/null 2>&1 && sleep 0.5
	rmmod -f nvidia_drm > /dev/null 2>&1 && sleep 0.5
	rmmod -f nvidia_modeset > /dev/null 2>&1 && sleep 0.5
	rmmod -f nvidia > /dev/null 2>&1 && sleep 0.5
	count_nvidia=`lsmod | grep -c nvidia`
	if [[ $count_nvidia -eq 0 ]]; then
		echo -e "${GREEN}> Unload modules successfull${NOCOLOR}"
		exit 0
	fi
done	
	
echo -e "${RED}> Unload modules failed${NOCOLOR}"
exit 1
